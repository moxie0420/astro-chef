---
import { actions } from "astro:actions";

import DefaultImage from "@components/assets/defaultImage.astro";
import Layout from "@layouts/layout.astro";
import Markdown from "@components/markdown.astro";
// import RecipeCard from "@components/recipe/recipeCard.astro";

const { method, id } = Astro.params;

const editing = Astro.url.searchParams.get("editing") === "true";

if (!method || !id) return Astro.redirect("/404");

const list = await Astro.callAction(actions.lists.getList.orThrow, {
  method,
  id,
});
---

<Layout title={list?.title || ""}>
  <div
    class="bg-surface mx-auto flex h-screen max-w-screen-2xl flex-col gap-2 overflow-auto bg-cover"
  >
    <div class="pb-3 text-center text-xl font-bold md:text-4xl lg:text-5xl">
      {list?.title}
    </div>
    <div class="mx-auto grid w-11/12 grid-cols-2 justify-between">
      <div class="bg-overlay m-auto w-fit rounded-md p-2">
        <DefaultImage src={list?.image || null} alt={list?.imageAlt || null} />
        <div class="mx-auto flex">
          {
            editing ? (
              <form class="relative flex w-full" id="image-alt">
                <input
                  name="alt"
                  class="selection:outline-pine border-muted bg-surface m-1 mx-auto w-full rounded-md border-2 selection:outline"
                  type="text"
                  placeholder="Image description"
                  value={list?.imageAlt}
                />
                <button
                  type="submit"
                  class="hover:text-pine absolute inset-y-0 right-3"
                >
                  
                </button>
                <input name="id" value={list?.id} hidden />
              </form>
            ) : (
              <p>{list?.imageAlt}</p>
            )
          }
        </div>
      </div>
      <Markdown body={list?.description || ""} editing={editing} />
    </div>
    <div
      class="bg-overlay mx-auto grid grid-cols-2 gap-1 overflow-y-scroll scroll-smooth rounded-lg p-2 px-2 md:grid-cols-3 lg:grid-cols-4 2xl:grid-cols-5"
    >
      {
        list?.recipes.map((r) => (
          <recipe-holder
            class="relative"
            data-list-id={id}
            data-recipe-id={r.recipeId}
          >
            <div id="delete" class="text-overlay absolute top-1 right-3 z-10">
              
            </div>
            {/* <RecipeCard recipe={r} /> */}
          </recipe-holder>
        ))
      }
    </div>
  </div>
</Layout>

<script>
  import { actions } from "astro:actions";
  import { navigate } from "astro:transitions/client";

  const form = document.querySelector("#image-alt") as HTMLFormElement;
  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    const formdata = new FormData(form);
    await actions.lists.setImageAlt(formdata);
    navigate(location.pathname + "?editing=true");
  });
</script>

<script>
  import { actions } from "astro:actions";

  class recipe extends HTMLElement {
    connectedCallback() {
      const listId = this.dataset.listId as string;
      const recipeId = this.dataset.recipeId as string;

      this.querySelector("div[id=delete]")?.addEventListener(
        "click",
        async () => {
          await actions.lists.removeRecipe({
            listId: parseInt(listId),
            recipeId: parseInt(recipeId),
          });
          location.reload();
        },
      );
    }
  }
  customElements.define("recipe-holder", recipe);
</script>
